# 前端构建阶段
FROM node:18 AS frontend-build
WORKDIR /app
# 复制 package.json 和 package-lock.json
COPY package*.json ./
# 安装依赖
RUN npm ci
# 复制源代码
COPY . .
# 构建项目
RUN npm run build

# 后端构建阶段
FROM node:18 AS backend-build
WORKDIR /app
COPY server/package*.json ./
RUN npm install
COPY server ./server
WORKDIR /app/server
RUN npm run build

# 生产环境镜像
FROM nginx:alpine
WORKDIR /app

# 安装 supervisor 和 node
RUN apk add --no-cache supervisor nodejs npm

# 拷贝前端构建产物到 nginx 静态目录
COPY --from=frontend-build /app/dist /usr/share/nginx/html

# 拷贝后端构建产物
COPY --from=backend-build /app/server/dist /app/server/dist
COPY --from=backend-build /app/server/node_modules /app/server/node_modules
COPY --from=backend-build /app/server/package*.json /app/server/
COPY --from=backend-build /app/server/.env /app/server/.env

# 拷贝 nginx 配置
COPY nginx.conf /etc/nginx/nginx.conf

# supervisor 配置
COPY supervisord.conf /etc/supervisord.conf

EXPOSE 80

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]